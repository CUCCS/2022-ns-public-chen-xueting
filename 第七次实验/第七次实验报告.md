# 实验七  Web 应用漏洞攻防

## 实验目的

- 了解常见 Web 漏洞训练平台；
- 了解 常见 Web 漏洞的基本原理；
- 掌握 OWASP Top 10 及常见 Web 高危漏洞的漏洞检测、漏洞利用和漏洞修复方法；

## 实验环境

- WebGoat-8.0
- Juice Shop

## 实验要求

- [x] 每个实验环境完成不少于 **5** 种不同漏洞类型的漏洞利用练习；
- [ ] （可选）使用不同于官方教程中的漏洞利用方法完成目标漏洞利用练习；
- [ ] （可选）**最大化** 漏洞利用效果实验；
- [x] （可选）编写 **自动化** 漏洞利用脚本完成指定的训练项目；
- [ ] （可选）定位缺陷代码；
- [ ] （可选）尝试从源代码层面修复漏洞；

## 实验要求

#### 一、环境搭建

- `docker-compose up -d` 一键搭建训练环境,并在kali本机上检查是否能够正常的访问webgoat的网页。

<img src="img\envi.png" alt="envi" style="zoom: 50%;" />

<img src="img\enter_.png" alt="enter" style="zoom:30%;" />

<img src="img\enter.png" alt="enter" style="zoom: 25%;" />

#### 二、Web goat下的漏洞利用练习

- **SQL injection：**通过把SQL命令插入到Web表单提交或输入[域名](https://www.qycn.com/domain/domainRegister.html)或页面请求的查询字符串，最终达到欺骗[服务器](https://www.qycn.com/)执行恶意的SQL命令。

<img src="img\1.png" alt="i" style="zoom:25%;" />

- 其中常用的语句有：1、数字型注入点，语句如“select * from 表名 where id=1 and 1=1”；2、字符型注入点，语句如“select * from 表名 where name...”；3、搜索型注入点select * from 表名 where 字段 like '%测试%' and '%1%'='%1%'等，其中 如果存在对空格符的限制，我们可以通过占位的形式在突破限制。
- 该漏洞练习中，同时使用到了burpsuite的抓包改包转发的形式来进行爆破

> 注：A2已全部完成但系统未显示，Pathtravel的第五题 搞不出来了
>
> 而这里遇到了一个很离谱的问题，在我关掉kali之后再打开，我的账号信息就被初始化了，也就是说，我的账号数据都没了了，我需要重头再来，目前还没有想好解决的方法，最好的结局就是每做完一个漏洞联系我有截图为证。

- **2FA Password Reset**（通过token越权）

- 将JWT头部和声明用https://jwt.io/ 进行解码，同时将alg置为none，进行base64的编码后，将得到的token替换到抓到的包中，在进行转发，就得到了如下结果。

  ![reset](img\reset.png)

- **JWT cracking**

  - 用户输入用户名和密码，提交登录信息给服务器，然后创建一个JWT返回给浏览器，浏览器将token发送到授权的Header头中，服务器检验token的值，从token中验明用户身份信息，验证身份后就会返回给用户相应的信息。

  以下为爆破使用的自动化脚本，将token及下载的字典贴到代码中运行，可以得到JWT中所需的payload。

```python
import termcolor
import jwt
if __name__ == "__main__":
    jwt_str = R'eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJXZWJHb2F0IFRva2VuIEJ1aWxkZXIiLCJhdWQiOiJ3ZWJnb2F0Lm9yZyIsImlhdCI6MTY2ODU4MjQ3NSwiZXhwIjoxNjY4NTgyNTM1LCJzdWIiOiJ0b21Ad2ViZ29hdC5vcmciLCJ1c2VybmFtZSI6IlRvbSIsIkVtYWlsIjoidG9tQHdlYmdvYXQub3JnIiwiUm9sZSI6WyJNYW5hZ2VyIiwiUHJvamVjdCBBZG1pbmlzdHJhdG9yIl19.81aurYgUrhhfKXODgNQMleuKgTIKEeWogYZDDjBXJ4g'

    with open('/home/kali/Desktop/google-10000-english-master/20k.txt') as f:
        for line in f:
            key_ = line.strip()
            try:
                jwt.decode(jwt_str, verify=True, key=key_)
                print('\r', '\bfound it -->', termcolor.colored(key_, 'green'), '<--')
                break
            except (jwt.exceptions.ExpiredSignatureError, jwt.exceptions.InvalidAudienceError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.ImmatureSignatureError):
                print('\r', '\bfound it -->', termcolor.colored(key_, 'green'), '<--')
                break
            except jwt.exceptions.InvalidSignatureError:
                print('\r', ' ' * 64, '\r\btry', key_, end='', flush=True)
                continue
        else:
            print('\r', '\bsorry! nothing be found.')

#### 
```

<img src="img\token_pass.png" alt="pass" style="zoom:50%;" />

![jwt](img\jwt.png)

- **Insecure Login**
- 模拟用户登录的透传，直接在burpsuite中进行抓包截取

<img src="img\a4.png" alt="a4" style="zoom:50%;" />

<img src="img\a4_.png" alt="a4_" style="zoom:50%;" />

- **XXE**

  - XXE注入，即XML External Entity，XML外部实体注入。通过 XML 实体，”SYSTEM”关键词导致 XML 解析器可以从本地文件或者远程 URI 中读取数据。所以攻击者可以通过 XML 实体传递自己构造的恶意值，是处理程序解析它。当引用外部实体时，通过构造恶意内容，可导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等危害。

  <img src="img\XXE.png" alt="xxe" style="zoom:50%;" />

  编写一个简单的XXE脚本注入即可

```bash
<?xml version="1.0"?>
<!DOCTYPE OMG [
<!ELEMENT name ANY>
<!ENTITY m0re SYSTEM "file:///">
]>
<comment>  <text>&OMG;</text></comment>
```

#### 三、Juice Shop下的漏洞利用练习

> 注意：在进行本次实验时由于是在webgoat的基础上进行的，所以需要先讲火狐的代理关掉，并执行`sudo docker run -d -p 3000:3000 bkimminich/juice-shop`命令后，才能正常的访问juiceshop 的页面。

- 开始吧！

<img src="img\start.png" alt="start" style="zoom:50%;" />

- 代码分析  **Score Board**

  - 通过定位源代码中的js文件，检索关键词score并没有发现，再去渲染的部分进行check，依次检索score关键字后，定位的下图位置，访问后通过。
  - <img src="img\score.png" alt="score" style="zoom:25%;" />

- 前端绕过 **Repetitive Registration**

  - 对register按钮进行资源定位，进入源码界面后，删掉语句`disable="true"`即可

  <img src="img\locate.png" alt="locate" style="zoom:50%;" />

- XSS **Bonus Payload**

  - 就把这个playload粘贴到各种网页内可提交的input框里，结果就是粘贴到搜索栏后回车执行即可。

- 敏感数据暴露 **Confidential Document**

  - 去各个页面检索可能存在的影藏信息，发现‘’关于我们‘’这个页有一个隐藏链接，点击进入后发现了一个隐藏的文件夹，查看文件即可。
  - <img src="img\hiden.png" alt="hiden" style="zoom:50%;" />
  - ![ftp](img\ftp.png)

- 暴力破解 **Bully Chatbot**

  - 如图所示
  - <img src="img\baoli.png" alt="暴力" style="zoom:25%;" />

# 反思与总结

- 第一，不听老师言，吃亏在眼前，在搭建了一天的环境终于恍然大悟要去换一个可靠的镜像源，同时检查自己是否处在一个正确的网络环境是一件极其重要的事情。
- 在利用burpsuite进行实验抓包的时候，需要注意到对浏览器代理的配置，由于8080端口已经被webgoat占用，所以我选择了一个新的代理端口8081，但是在在实验过程中发现，更改了代理端口会导致我的webgoat页面不能正常的访问，所以我只能在8080 与8081中反复切换。
- 在进行juiceshop的环境下的实验的时候需要注意，环境遗留问题，在不使用burpsuite进行抓包时，需要关闭浏览器的代理来完成对juiceshop的正常访问。
- 本次实验由于没有经验，在完成一部分实验后我并没有有意识的对实验过程进行留存，而在我重新打开kali时痛心的发现进度丢失了，在那瞬间我是心如死灰的，而我又实在没有勇气重新做一遍。吃一堑长一智，之后的每个测试联系我都便做边截图，所有这次的实验报告写的不算详实，下一一定。

# 参考资料

[实验 · 网络安全 (c4pr1c3.github.io)](https://c4pr1c3.github.io/cuc-ns/chap0x07/exp.html)

[webgoat实战指南 - FreeBuf网络安全行业门户](https://www.freebuf.com/column/149807.html)

[(30条消息) 靶场Juice-Shop学习_zhangwenbo1229的博客-CSDN博客](https://blog.csdn.net/qq_36531487/article/details/113863816)
