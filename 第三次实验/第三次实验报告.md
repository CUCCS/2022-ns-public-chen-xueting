# 第三次实验报告

### 实验环境

- VirtualBox 虚拟机
- Attacker：Kali Rolling 2022
- Gateway：Debian Buster
- Victim：Kali

### 实验目的

- [x] ​	在Kali Linux中安装`tinyproxy`
- [x] ​	然后用**主机**设置浏览器代理指向`tinyproxy`建立的HTTP正向代理
- [x] ​	在Kali中用`wireshark`抓包，分析抓包过程
- [x] ​	理解HTTP正向代理 HTTPS 流量的特点。

### 前置准备

- #### 各主机基本信息

  - 攻击者主机
    - 10.0.2.4
  - 受害者主机
    - 172.16.111.124
  - 网关
    - 10.0.2.15/24      |      172.16.111.1

- #### tinyproxy安装攻略

```bash
apt-get update
apt-get install tinyproxy

# 编辑tinyproxy，取消Allow 10.0.0.0/8行首注释
/etc/init.d/tinyproxy start

# 设置虚拟机联网方式为NAT和端口转发，默认tinyproxy监听8888端口
# 主机浏览器设置代理指向tinyproxy的服务地址
# 虚拟机里开启wireshark抓包
# 主机访问https站点
# 结束抓包，分析抓包结果
```

- #### wireshark分析HTTP代理流量技巧：

  - `http.request.method eq CONNECT` 查看所有HTTPS代理请求

  - `http.request.method eq GET` 查看所有HTTP GET代理请求

  - [使用wireshark解密HTTPS流量的方法](http://support.citrix.com/article/CTX116557) [方法2](https://wiki.wireshark.org/SSL)

  - 使用wireshark提取pcap包中的SSL证书
    - wireshark首选项中确认TCP协议的Allow subdissector to reassemble TCP streams选项处于启用状态
    - 通过显示筛选过滤规则（例如：tcp.port == 443），找到SSL会话
    - 通过packet list里的info列找到Certificate
      - 在packet details面板里依次展开Handshake Protocol: Certificate --> Certificates，如果有多个证书，会看到多个默认折叠起来的Certificate
      - 右键选中Certificate，在右键菜单里使用Export Selected Packet Bytes功能即可导出DER格式的SSL证书
    - 使用openssl命令行工具解析DER证书 `openssl x509 -in xxx.der -inform der -text -noout`

### 实验过程

#### 	一、网关、Attacker、victim配置

- 网关

  ```bash
  # 安装
  apt-get update && apt-get install tinyproxy -y
  
  # 编辑 tinyproxy 配置文件，取消 Allow 10.0.0.0/8 行首注释，允许来自 10.0.0.0/8 网段的主机使用此代理服务器
  sudo vim /etc/tinyproxy/tinyproxy.conf
  
  # 配置完成后保存并重启服务使配置加载
  systemctl restart tinyproxy
  
  #查看状态
  systemctl status tinyproxy
  ```

  <img src="img\vim.png" alt="vim" style="zoom:50%;" />

  <img src="img\restart.png" alt="vim" style="zoom: 33%;" />

- attacker-配置代理转发服务

  <img src="img\setting.png" alt="vim" style="zoom: 33%;" />

- victim-启用 Apache2 服务

  <img src="img\apache_st.png" alt="vim" style="zoom: 33%;" />

#### 	二、抓包与流量分析

- 在attacker和victim中同时打开wireshark并开启监听

- 在apache2服务关闭，或开启时分别通过attacker访问victim的地址`172.16.111.124`

  - Apache关闭

    <img src="img\accessdeny.png" alt="vim" style="zoom: 33%;" />

  - Apache开启

    <img src="img\acss_into.png" alt="vim" style="zoom: 33%;" />

- 分别分析attacker和victim的wireshark抓包情况

  - victim 

    <img src="img\vim_wire.png" alt="vim" style="zoom: 33%;" />

    > 分析发现出现了via:的信息，代表着攻击者主机的信息被隐藏。

  - attacker

    <img src="img\at_wire.png" alt="vim" style="zoom: 33%;" />

    > `Via:  Srt Port：8888`等信息，说明了attacker访问靶机是通过代理服务器 tinyproxy 的 8888 端口实现的，也就是说，attacker访问靶机是通过代理服务器去访问而不是之际访问。

### 反思与总结

在实现开启Apache2服务，浏览器访问victim时，出现持续访问失败的情况，是因为，本次的网络实验环境是在实验四的基础上进行的（网络配置为internal），复查后更改attacker的网络配置为NAT 网络后即可。

这次踩得最大的一个坑就在于，我上次实验把防火墙给打开了，所以这一次在打开Apache2后依旧不能访问靶机，一开始我以为是网络配置的问题，在无数次重启以后我灵光一闪，阿弥陀佛。

### 参考链接

[实验 · 网络安全 (c4pr1c3.github.io)](https://c4pr1c3.github.io/cuc-ns/chap0x03/exp.html)

[如何使用代理服务器上网-月光博客 (williamlong.info)](https://www.williamlong.info/archives/2057.html)

[ HTTP代理服务器实验_lemonalla的博客-CSDN博客](https://blog.csdn.net/lemonalla/article/details/105592207)
